# HRE 연결마스터 완벽한 구현 가이드
## VBA 초보자도 따라할 수 있는 전체 매뉴얼

**버전**: 1.00
**작성일**: 2026-01-21
**대상**: VBA를 처음 접하는 사용자
**목적**: HRE 연결재무제표 작성을 위한 Excel 연결마스터 시스템 구축
**소요 시간**: 약 3-4시간 (첫 구축 시)

---

## 📚 목차

### PART 1: 기본 설정
1. [시스템 개요](#1-시스템-개요)
2. [사전 준비사항](#2-사전-준비사항)
3. [Excel 파일 및 시트 생성](#3-excel-파일-및-시트-생성)
4. [Excel 테이블 구조 생성](#4-excel-테이블-구조-생성)

### PART 2: VBA 및 리본 메뉴
5. [VBA 모듈 임포트](#5-vba-모듈-임포트)
6. [UserForm 임포트](#6-userform-임포트)
7. [리본 메뉴 설치](#7-리본-메뉴-설치)

### PART 3: 데이터 연결
8. [SharePoint 폴더 구조 생성](#8-sharepoint-폴더-구조-생성)
9. [시산표 파일 준비 및 업로드](#9-시산표-파일-준비-및-업로드)
10. [Power Query 연결 설정](#10-power-query-연결-설정)

### PART 4: 테스트 및 검증
11. [CoA 마스터 데이터 로드](#11-coa-마스터-데이터-로드)
12. [전체 워크플로 테스트](#12-전체-워크플로-테스트)
13. [환율 조회 테스트](#13-환율-조회-테스트)
14. [최종 검증 체크리스트](#14-최종-검증-체크리스트)

### PART 5: 참고자료
15. [문제 해결 가이드](#15-문제-해결-가이드)
16. [부록: 테이블 스키마 전체](#16-부록-테이블-스키마-전체)

---

## PART 1: 기본 설정

## 1. 시스템 개요

### 1.1 HRE 연결마스터란?

한국재생에너지(HRE) 그룹의 **연결재무제표 작성을 위한 Excel 기반 자동화 시스템**입니다.

**핵심 워크플로**:
```
SharePoint 시산표 → Power Query 취합 → CoA 자동 매핑 → 환율 적용 → 연결재무제표 생성
```

**주요 기능**:
- 📊 **CoA 자동 매핑**: 법인별 계정과목(5자리) → PwC 표준 계정과목(6자리)
- 💱 **환율 자동 조회**: KEB 하나은행 API를 통한 실시간 환율 데이터
- 🔍 **변종 인식**: `_내부거래`, `_IC` 접미사 자동 감지 및 별도 처리
- ✅ **자동 검증**: 차변=대변 일치 여부, 법인코드 유효성 등
- 📤 **일괄 내보내기**: 연결재무제표 Excel 파일 자동 생성

### 1.2 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│         SharePoint (데이터 저장소)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ HRE-001 시산표│  │ HRE-002 시산표│  │ HRE-003 시산표│  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────┬──────────────────────────────────┘
                       │ Power Query
                       ▼
┌─────────────────────────────────────────────────────────┐
│              Excel 연결마스터 (본 시스템)                │
│                                                         │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐           │
│  │ CoAMaster│ → │ Raw_CoA  │ → │   PTB    │           │
│  │ (표준계정)│   │ (매핑이력)│   │ (시산표) │           │
│  └──────────┘   └──────────┘   └──────────┘           │
│                       ↓                                 │
│              VBA 자동 매핑 + 환율 적용                   │
│                       ↓                                 │
│  ┌──────────────────────────────────────────────────┐  │
│  │       연결재무제표 (BS/PL)                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 1.3 BEP 대비 주요 차이점

| 항목 | BEP v1.98 | HRE v1.00 | 영향 |
|------|-----------|-----------|------|
| **CoA 매핑 방식** | 계정코드 전체 일치 | 첫 5자리 매칭 | 유연성 향상 |
| **변종 처리** | 수동 구분 | `_내부거래`, `_IC` 자동 인식 | 자동화 |
| **환율 조회** | 수동 입력 | KEB API 자동 조회 | 실시간 |
| **다중 통화** | 단일 (KRW) | KRW/USD/EUR/JPY/CNY 등 | 글로벌 |
| **MC 연결** | 지원 | 제거 (HRE 불필요) | 단순화 |

---

## 2. 사전 준비사항

### 2.1 필수 소프트웨어

#### ✅ Microsoft Excel
- **최소**: Excel 2016 (Windows)
- **권장**: Microsoft 365 (최신 버전)
- **필수 기능**: 매크로, Power Query, 피벗 테이블

**확인 방법**:
1. Excel 열기 → **파일** → **계정** → **Excel 정보**
2. 버전 번호 확인 (예: "버전 2406")

#### ✅ Custom UI Editor
- **용도**: 리본 메뉴 XML 편집
- **다운로드**: https://github.com/OfficeDev/office-custom-ui-editor/releases
- **파일**: `OfficeCustomUIEditorSetup.msi` (약 2MB)
- **설치**: 기본값으로 진행

**✅ 성공 확인**:
- 시작 메뉴에서 "Custom UI Editor" 검색하여 실행 가능

### 2.2 필수 권한

#### SharePoint 접근 권한
- **사이트**: `https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation`
- **필요 권한**: 편집 권한 (Edit) 이상
- **확인 방법**:
  1. 브라우저에서 위 URL 접속
  2. "Documents" 폴더 보임 → ✅ 정상
  3. "액세스 거부" 오류 → ❌ 권한 요청 필요

#### 이메일 도메인
- **허용 도메인**: `@pwc.com`, `@bepsolar.com`, `@hre.com`
- **확인 방법**: Outlook에서 본인 이메일 주소 확인

#### Excel 보안 설정
1. Excel 열기 → **파일** → **옵션** → **보안 센터** → **보안 센터 설정**
2. **매크로 설정**:
   - ☑ "디지털 서명된 매크로를 제외한 모든 매크로 포함" 선택
3. **신뢰할 수 있는 위치**:
   - **위치 추가** 클릭
   - 경로: `/Users/jaewookim/Desktop/Project/HRE/작업/`
   - ☑ "이 위치의 하위 폴더도 신뢰" 체크
4. **확인** → Excel 재시작

### 2.3 파일 및 폴더 준비

**작업 폴더 구조** (자동 생성 완료):
```
/Users/jaewookim/Desktop/Project/HRE/작업/
├── VBA_Export/              (34개 VBA 모듈)
├── UserForms/               (32개 UserForm 파일)
├── Documentation/           (기술 문서)
├── PowerQuery/              (M 코드 템플릿)
└── 완벽한_구현_가이드.md     (현재 파일)
```

---

## 3. Excel 파일 및 시트 생성

### 3.1 새 Excel 파일 생성

#### 단계 1: 빈 통합 문서 생성

1. **Excel 실행**
2. **파일** → **새로 만들기** → **빈 통합 문서**
3. **중요**: Sheet1, Sheet2, Sheet3이 기본 생성됨

#### 단계 2: 파일 저장

1. **Ctrl + S** 또는 **파일** → **다른 이름으로 저장**
2. 저장 정보:
   - **파일명**: `연결마스터_HRE_v1.00.xlsm`
   - **파일 형식**: **Excel 매크로 사용 통합 문서 (*.xlsm)** ⭐ 중요!
   - **저장 위치**: `/Users/jaewookim/Desktop/Project/HRE/작업/`
3. **저장** 클릭

**✅ 성공 확인**:
- 파일명이 `연결마스터_HRE_v1.00.xlsm`으로 표시
- 제목 표시줄에 "[호환 모드]" 없음

### 3.2 워크시트 생성 및 이름 변경

#### 필요한 시트 목록 (총 14개)

| 순서 | 시트 이름 | CodeName | 초기 상태 | 표시 여부 | 용도 |
|------|-----------|----------|-----------|-----------|------|
| 1 | Guide | Sheet1 | 빈 시트 | 표시 | 사용자 안내 문서 |
| 2 | CoAMaster | CoAMaster | **테이블 생성 필요** | 표시 | PwC 표준 계정과목 (178개) |
| 3 | CorpMaster | CorpMaster | **테이블 생성 필요** | 표시 | 법인 마스터 데이터 |
| 4 | CorpCoA | CorpCoA | **테이블 생성 필요** | 표시 | 법인별 CoA 매핑 이력 |
| 5 | BSPL | BSPL | **테이블 생성 필요** | 표시 | 재무상태표 & 손익계산서 |
| 6 | **법인별 BSPL** | **CorpBSPL** | **피벗 테이블 필요** | 표시 | 법인별 BSPL 크로스탭 |
| 7 | ADBS | ADBS | **테이블 생성 필요** | 표시 | 취득/처분 재무상태표 |
| 8 | Verify | Verify | 빈 시트 | 표시 | 검증 피벗 테이블 (VBA 자동 생성) |
| 9 | Check | Check | **범위 생성 필요** | 표시 | 워크플로 상태 추적 |
| 10 | HideSheet | HideSheet | **테이블 생성 필요** | 숨김 | 설정 데이터 (결산연월, 환율 등) |
| 11 | DirectoryURL | DirectoryURL | 빈 시트 | 숨김 | 파일 경로 저장 |
| 12 | Memo | Memo | 빈 시트 | 숨김 | 내부 메모 |
| 13 | AddCoA | AddCoA | **테이블 생성 필요** | 숨김* | CoA 입력 (PTB용) |
| 14 | AddCoA_ADBS | AddCoA_ADBS | **테이블 생성 필요** | 숨김* | CoA 입력 (ADBS용) |

*AddCoA 시트는 작업 완료 후 VBA에서 자동으로 숨김 처리됩니다.

> **중요**: CodeName은 VBA 편집기 속성 창에서 **(Name)** 속성을 변경해야 합니다.

#### 시트 생성 방법

**방법 1: 기존 시트 이름 변경**
1. Sheet1 탭 우클릭 → **이름 바꾸기**
2. `Guide` 입력 → Enter
3. Sheet2 → `CoAMaster`
4. Sheet3 → `CorpMaster`

**방법 2: 새 시트 추가**
1. 시트 탭 옆 **+** 버튼 클릭 (또는 우클릭 → **삽입** → **워크시트**)
2. 새 시트 이름을 `CorpCoA`로 변경
3. 위 표의 순서대로 13개 시트 모두 생성

#### 시트 순서 정렬

시트 탭을 드래그하여 위 표의 순서대로 정렬하세요.

**✅ 성공 확인**:
- 총 13개 시트 존재
- 시트 이름이 정확히 일치 (대소문자, 띄어쓰기 포함)
- 순서가 Guide → CoAMaster → ... → AddCoA_ADBS 순

#### 시트 숨기기

1. HideSheet 탭 우클릭 → **숨기기**
2. DirectoryURL 탭 우클릭 → **숨기기**
3. Memo 탭 우클릭 → **숨기기**

**참고**: AddCoA, AddCoA_ADBS는 나중에 VBA에서 자동으로 숨김 처리되므로 지금은 표시 상태 유지

---

### 3.3 ⭐ 시트 레이아웃 원칙 (중요!)

**모든 시트는 B열부터 시작합니다** (HideSheet 제외)

#### 레이아웃 구조

```
    A열         B열         C열         D열    ...
┌────────┬───────────┬───────────┬───────────┐
│        │           │           │           │  1행: B1 비움 (VBA가 나중에 채움)
│ 여백   │           │           │           │
│(너비   ├───────────┴───────────┴───────────┤
│ 3-4)   │  시트 제목 (예: "CoA 마스터")      │  2행: 제목
│        ├───────────┬───────────┬───────────┤
│        │           │           │           │  3행: 빈 행
│        ├───────────┼───────────┼───────────┤
│        │ 헤더1     │ 헤더2     │ 헤더3     │  4행: 테이블 헤더 시작
│        ├───────────┼───────────┼───────────┤
│        │ 데이터    │ 데이터    │ 데이터    │  5행~: 데이터
└────────┴───────────┴───────────┴───────────┘
```

#### 핵심 규칙

| 요소 | 위치 | 내용 | 비고 |
|------|------|------|------|
| **A열** | 전체 | 비움 | 너비 3-4 (여백용) |
| **B1** | 1행 | 비움 | VBA가 나중에 수식 자동 삽입 |
| **B2** | 2행 | 시트 제목 (한글) | 예: "CoA 마스터", "법인 마스터" |
| **B3** | 3행 | 빈 행 | - |
| **B4~** | 4행부터 | 테이블 헤더 시작 | ListObject 테이블 범위 |

#### 예외: HideSheet

**HideSheet만 A1부터 시작합니다!**
- 이유: 설정 데이터 테이블이 여러 개이고, 여백 불필요
- 환율 테이블도 A1부터 시작 (mod_17_ExchangeRate.bas에서 참조)

**✅ 성공 확인**:
- 각 시트의 A열 너비가 3-4로 설정됨
- B2에 시트 제목 입력됨
- B4부터 테이블 헤더가 시작됨

---

## 4. Excel 테이블 구조 생성

### 4.1 중요: 빈 시트 vs 테이블 구조

**질문**: "빈 시트로 시작해도 되나요?"

**답변**:
- ❌ **아니요!** 일부 시트는 반드시 **ListObject 테이블을 미리 생성**해야 합니다.
- VBA 코드가 테이블 이름(`ListObjects("테이블명")`)으로 데이터를 참조하기 때문입니다.
- 테이블이 없으면 VBA 실행 시 "개체가 필요합니다" 오류 발생

**테이블 생성 필요 시트**:
- CoAMaster, CorpMaster, CorpCoA, BSPL, ADBS, HideSheet, AddCoA, AddCoA_ADBS

**빈 시트로 유지**:
- Guide, Verify, Check, DirectoryURL, Memo

### 4.2 CoAMaster 시트 - Master 테이블

#### 단계 1: 시트 제목 및 레이아웃

1. **A열 너비 설정**: A열 선택 → 우클릭 → **열 너비** → `3.25` 입력
2. **B2 셀에 제목 입력**: `CoA 마스터`
3. **B3 행**: 빈 행 유지

#### 단계 2: 헤더 행 작성

CoAMaster 시트의 **B4:K4**에 아래 헤더를 입력하세요:

| B4 | C4 | D4 | E4 | F4 | G4 | H4 | I4 | J4 | K4 |
|----|----|----|----|----|----|----|----|----|-----|
| Account | Description | 연결계정명 | 분류 | Category | BSPL | 대분류 | Ranking | 부호 | 금액 |

#### 단계 3: 테이블 변환

1. **B4 셀 선택**
2. **Ctrl + T** (또는 **삽입** 탭 → **표**)
3. "표에 머리글 포함" ☑ 체크 → **확인**
4. 테이블 디자인 탭에서 **테이블 이름**을 `Master`로 변경

**테이블 스타일**: "표 스타일 중간 2" (파란색) 권장

#### 단계 4: 데이터 형식 설정

각 컬럼의 데이터 형식을 설정:

| 컬럼 | 형식 | 설정 방법 |
|------|------|-----------|
| Account (B) | 텍스트 | 컬럼 전체 선택 → 우클릭 → **셀 서식** → **텍스트** |
| Description (C) | 텍스트 | 동일 |
| 연결계정명 (D) | 텍스트 | 동일 |
| Ranking (I) | 숫자 | **숫자** → 소수 자릿수: 0 |
| 금액 (K) | 통화 | **통화** → 기호: ₩, 소수 자릿수: 0 |

**✅ 성공 확인**:
- A열이 빈 여백 (너비 3.25)
- B2에 "CoA 마스터" 제목 표시
- B4:K4에 테이블 필터 화살표 버튼 표시
- 테이블 이름이 "Master"로 표시
- B5 셀이 빈 상태 (데이터는 나중에 VBA로 삽입)

### 4.3 CorpMaster 시트 - Corp 테이블

**특이사항**: CorpMaster 시트는 여러 테이블이 있으며, **Corp 테이블은 B33부터 시작**합니다.

#### 단계 1: 시트 제목
1. **A열 너비**: `2.75`
2. **B2**: `법인 마스터`

#### 단계 2: Corp 테이블 헤더 (B33:Q33)

**위치 주의!** Corp 테이블은 B4가 아닌 **B33**부터 시작합니다.

| B33 | C33 | D33 | E33 | F33 | G33 | H33 | I33 | J33 | Q33 |
|----|----|----|----|----|----|----|----|----|----|
| 법인코드 | 법인명 | Entity Name | Hierarchy | Scope | 취득일 | 처분일 | 지분율 | 기능통화 | Consolidation Method |

#### 단계 3: 테이블 생성
1. **B33 선택** → **Ctrl + T**
2. 테이블 이름: `Corp`

#### 데이터 형식:
| 컬럼 | 형식 | 예시 |
|------|------|------|
| 법인코드 (A) | 텍스트 | HRE-001 |
| 취득일 (F) | 날짜 | 2020-01-01 |
| 처분일 (G) | 날짜 (또는 빈칸) | 2025-12-31 |
| 지분율 (H) | 백분율 | 100% (1.00) |
| 기능통화 (I) | 텍스트 | KRW |

**참고**: 처분일은 빈칸 가능 (현재 보유 중인 법인)

**✅ 성공 확인**:
- 테이블 이름 "Corp" 확인
- 10개 컬럼 헤더 정확히 일치

### 4.4 CorpCoA 시트 - Raw_CoA 테이블

#### 단계 1: 시트 제목
1. **A열 너비**: `3.25`
2. **B2**: `법인별 CoA`

#### 단계 2: 헤더 행 (B4:J4)

| B4 | C4 | D4 | E4 | F4 | G4 | H4 | I4 | J4 |
|----|----|----|----|----|----|----|----|----|
| 법인코드 | 계정코드 | 연결계정명 | Reporting COA | Account | Description | Variant Type | Internal Transaction Flag | 비고 |

#### 단계 3: 테이블 생성
1. **B4 선택** → **Ctrl + T**
2. 테이블 이름: `Raw_CoA`

#### 데이터 형식:
모든 컬럼 **텍스트**

**중요**: 이 테이블은 **CoA 매핑 이력**을 저장합니다.
- 계정코드 예시: `10300`, `11401_내부거래`, `11402_IC`
- Variant Type: `BASE`, `INTERCO_KR`, `INTERCO_IC`, `CONSOLIDATION`
- Internal Transaction Flag: `Y` 또는 `N`

**✅ 성공 확인**:
- 테이블 이름 "Raw_CoA" 확인
- 9개 컬럼 헤더 정확히 일치

### 4.5 BSPL 시트 - PTB 테이블

#### 단계 1: 시트 제목
1. **A열 너비**: `3.25`
2. **B2**: `합산 BSPL`

#### 단계 2: 헤더 행 (B4:I4)

| B4 | C4 | D4 | E4 | F4 | G4 | H4 | I4 |
|----|----|----|----|----|----|----|----|
| 법인코드 | 법인별CoA | 법인별계정과목명 | PwC_CoA | PwC_계정명 | 대분류 | 중분류 | 금액 |

#### 단계 3: 테이블 생성
1. **B4 선택** → **Ctrl + T**
2. 테이블 이름: `PTB`

#### 단계 4: 데이터 형식
| 컬럼 | 형식 |
|------|------|
| 법인코드 (B) | 텍스트 |
| 법인별CoA (C) | 텍스트 |
| 법인별계정과목명 (D) | 텍스트 |
| PwC_CoA (E) | 텍스트 |
| PwC_계정명 (F) | 텍스트 |
| 대분류 (G) | 텍스트 |
| 중분류 (H) | 텍스트 |
| 금액 (I) | 통화 |

**중요**: 이 테이블은 **Power Query로 자동 채워집니다** (빈 상태로 두세요).

**✅ 성공 확인**:
- 테이블 이름 "PTB" 확인
- 8개 컬럼 헤더 정확히 일치
- B5 셀 빈 상태

### 4.6 HideSheet 시트 - 설정 테이블 (7개)

HideSheet는 **7개의 별도 테이블**을 포함합니다. Power Query가 참조하는 테이블이 포함되어 있어 **정확한 컬럼명**이 중요합니다.

#### 테이블 1: 결산연월 (A1:B2) ⭐ Power Query 참조

| A1 | B1 |
|----|----|
| 결산연도 | 결산월 |
| 2026 | 1 |

**테이블 생성**:
1. A1:B2 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `결산연월`

**⚠️ 중요**: Power Query가 `결산연도`, `결산월` 컬럼명을 정확히 참조합니다.

#### 테이블 2: Path (D1:D2) ⭐ Power Query 참조

| D1 |
|----|
| 메인주소 |
| https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation |

**테이블 생성**:
1. D1:D2 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `Path`

**⚠️ 중요**:
- Power Query "메인주소" 쿼리가 `Path` 테이블의 `메인주소` 컬럼을 참조
- VBA frmSPO에서 이 셀(E2)에 URL 저장

#### 테이블 3: TempPath (F1:I2) ⭐ Power Query 참조

| F1 | G1 | H1 | I1 |
|----|----|----|-----|
| 이름 | 구분 | Description | 경로 |
| (빈칸) | (빈칸) | (빈칸) | (빈칸) |

**테이블 생성**:
1. F1:I2 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `TempPath`

**⚠️ 중요**:
- Power Query "회사결산 주소" 쿼리가 `경로` 컬럼을 참조
- VBA frmDirectory에서 선택한 폴더 경로가 여기 저장됨
- **컬럼명 `경로`는 반드시 정확해야 함** (Temp4 등 다른 이름 불가)

#### 테이블 4: Mode (K1:K2)

| K1 |
|----|
| Mode |
| D |

**테이블 생성**:
1. K1:K2 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `Mode`

**참고**: D=Debit(차변), C=Credit(대변) - PTB 합산 방향 설정

#### 테이블 5: Link (M1:N2)

| M1 | N1 |
|----|----|
| SPO_Link | Path |
| https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation | (빈칸) |

**테이블 생성**:
1. M1:N2 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `Link`

#### 테이블 6: 비경상적 (P1:Q1)

| P1 | Q1 |
|----|----|
| PwC_CoA | PwC_계정과목명 |

**테이블 생성**:
1. P1:Q1 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `비경상적`
4. **참고**: 데이터는 빈 상태 (비경상 항목 발생 시 수동 입력)

#### 테이블 7: 환율마스터 (S1:T1)

| S1 | T1 |
|----|----|
| 통화 | 환율 |

**테이블 생성**:
1. S1:T1 범위 선택
2. **Ctrl + T**
3. 테이블 이름: `환율마스터`
4. **참고**: 데이터는 환율 조회 시 자동 생성됨

**추가 범위 설정**:
- **N2 셀**: 버전 정보 표시 위치 (VBA가 자동으로 버전 번호 입력)

**✅ 성공 확인**:
- HideSheet에 7개 테이블 존재
- 테이블 이름: 결산연월, Path, TempPath, Mode, Link, 비경상적, 환율마스터
- **Power Query 참조 테이블 컬럼명 확인**:
  - 결산연월: `결산연도`, `결산월`
  - Path: `메인주소`
  - TempPath: `이름`, `구분`, `Description`, `경로`

### 4.7 AddCoA 시트 - CoA_Input 테이블

#### 단계 1: 시트 제목
1. **A열 너비**: `3.25`
2. **B2**: `CoA 입력 (PTB)`

#### 단계 2: 헤더 행 (B4:H4)

| B4 | C4 | D4 | E4 | F4 | G4 | H4 |
|----|----|----|----|----|----|----|
| 법인코드 | 법인별CoA | 법인별계정과목명 | PwC_CoA | PwC_계정과목명 | 적요 | 비고 |

#### 단계 3: 테이블 생성
1. **B4 선택** → **Ctrl + T**
2. 테이블 이름: `CoA_Input`

**참고**: 이 테이블은 VBA의 `Fill_Input_Table()` 함수가 자동으로 채웁니다.

**✅ 성공 확인**:
- 테이블 이름 "CoA_Input" 확인
- 7개 컬럼 헤더 정확히 일치

### 4.8 AddCoA_ADBS 시트 - CoA_Input_ADBS 테이블

AddCoA와 동일한 구조:

#### 단계 1: 시트 제목
1. **A열 너비**: `3.25`
2. **B2**: `CoA 입력 (ADBS)`

#### 단계 2: 헤더 행 (B4:H4)
AddCoA와 동일

#### 단계 3: 테이블 생성
1. **B4 선택** → **Ctrl + T**
2. 테이블 이름: `CoA_Input_ADBS`

**✅ 성공 확인**:
- 테이블 이름 "CoA_Input_ADBS" 확인

### 4.9 법인별 BSPL 시트 - 피벗 테이블 (CorpBSPL)

**중요**: 이 시트는 테이블이 아닌 **피벗 테이블**을 사용합니다.

#### 단계 1: 시트 생성 및 CodeName 설정
1. 새 시트 추가 → 이름: `법인별 BSPL`
2. **VBA 편집기(Alt+F11)** 열기
3. 프로젝트 탐색기에서 새 시트 선택
4. **속성 창(F4)** → **(Name)** 속성을 `CorpBSPL`로 변경

#### 단계 2: 열 너비 설정

| 열 | 너비 | 용도 |
|----|------|------|
| A | 3.25 | 왼쪽 여백 (빈 열) |
| B | 17.25 | PwC_CoA 코드 |
| C | 46.75 | 계정명 (가장 넓은 열) |
| D~P | 13.0 | 각 법인별 금액 |
| Q | 13.0 | 합계 열 |

#### 단계 3: 기본 레이아웃

| 셀 | 값 |
|----|-----|
| B2 | `법인별 BSPL` |
| B4 | `합계: 금액` |
| D4 | `법인코드` |
| E4 | `법인명` |
| B6 | `PwC_CoA` |
| C6 | `PwC_계정명` |

#### 단계 4: 피벗 테이블 생성

**데이터 소스**: BSPL 시트의 PTB 테이블

1. **삽입** → **피벗 테이블**
2. 데이터 원본: `BSPL!PTB[#All]` (또는 PTB 테이블 전체)
3. 위치: `법인별 BSPL!$B$6`
4. 피벗 테이블 이름: `법인별BSPL` (공백 없음!)

**피벗 테이블 필드 설정**:
- **행(Rows)**: `PwC_CoA`, `PwC_계정명`
- **열(Columns)**: `법인코드`
- **값(Values)**: `금액` (합계)

#### 단계 5: VBA 참조 확인

코드에서 다음과 같이 참조됩니다:
```vba
Set pt = CorpBSPL.PivotTables("법인별BSPL")
CorpBSPL.Unprotect PASSWORD
' ... 작업 ...
CorpBSPL.Protect PASSWORD, UserInterfaceOnly:=True
```

**✅ 성공 확인**:
- 시트 CodeName이 `CorpBSPL`인지 확인 (VBA 속성 창)
- 피벗 테이블 이름이 정확히 `법인별BSPL`인지 확인 (공백 없음!)
- 피벗 테이블 → 우클릭 → 피벗 테이블 옵션 → 이름 확인

---

### 4.10 ADBS 시트 - AD_BS 테이블

#### 단계 1: 시트 제목
1. **A열 너비**: `3.25`
2. **B2**: `취득, 처분 BS`

#### 단계 2: 헤더 행 (B4:J4)

| B4 | C4 | D4 | E4 | F4 | G4 | H4 | I4 | J4 |
|----|----|----|----|----|----|----|----|----|
| 법인코드 | 법인별CoA | 법인별계정과목명 | PwC_CoA | PwC_계정명 | 금액 | 취득/처분 | 일자 | 대분류 |

#### 단계 3: 테이블 생성
1. **B4 선택** → **Ctrl + T**
2. 테이블 이름: `AD_BS`

**참고**: 취득/처분이 없는 경우 이 시트는 사용하지 않을 수 있습니다.

**✅ 성공 확인**:
- 테이블 이름 "AD_BS" 확인

### 4.10 Check 시트 - 워크플로 상태 추적

Check 시트는 **테이블이 아닌 명명된 범위**를 사용합니다.

#### 레이아웃 설계:

**A1:F1** (헤더):
| A1 | B1 | C1 | D1 | E1 | F1 |
|----|----|----|----|----|----|
| 단계 | 작업명 | 설명 | 상태 | 작업일시 | 작업자 |

**A12:F23** (12개 워크플로 단계):

| 단계 | 작업명 | 설명 | 상태 | 작업일시 | 작업자 |
|------|--------|------|------|----------|--------|
| 1 | SPO 설정 | SharePoint URL 설정 | | | |
| 2 | 조직 설정 | 부서 코드 설정 | | | |
| 3 | 결산연월 설정 | 2026년 1월 설정 | | | |
| 4 | 법인 추가 | 대상 법인 등록 | | | |
| 5 | 연결범위 설정 | Scope 지정 | | | |
| 6 | CoA 마스터 검토 | 178개 계정 확인 | | | |
| 7 | CoA 확인 및 데이터 합산 | PTB 데이터 로드 | | | |
| 8 | CoA 추가/수정/삭제 | 매핑 완료 | | | |
| 9 | 환율 조회 | 평균/기말 환율 조회 | | | |
| 10 | 합산 검증 | 차변=대변 검증 | | | |
| 11 | 취득/처분 CoA 확인 | ADBS 데이터 로드 | | | |
| 12 | 취득/처분 검증 | ADBS 검증 | | | |

#### 서식 설정:
1. A1:F1 범위 선택 → **진하게**, **배경색: 파란색**, **글자색: 흰색**
2. D12:D23 범위에 조건부 서식 추가:
   - 값이 "Complete"이면 **녹색 배경**
   - 값이 "In Progress"이면 **노란색 배경**

**✅ 성공 확인**:
- Check 시트에 12개 단계 표시
- 헤더 행 스타일 적용
- 상태 컬럼(D) 빈 상태

### 4.11 전체 테이블 목록 최종 확인

아래 명령으로 **모든 테이블이 정확히 생성되었는지** 확인하세요:

**VBA 즉시 실행 창에서 테스트** (나중에 VBA 임포트 후):
```vba
Sub CheckTables()
    Debug.Print "CoAMaster: " & CoAMaster.ListObjects("Master").Name
    Debug.Print "CorpMaster: " & CorpMaster.ListObjects("Corp").Name
    Debug.Print "CorpCoA: " & CorpCoA.ListObjects("Raw_CoA").Name
    Debug.Print "BSPL: " & BSPL.ListObjects("PTB").Name
    Debug.Print "HideSheet: " & HideSheet.ListObjects("결산연월").Name
    Debug.Print "AddCoA: " & AddCoA.ListObjects("CoA_Input").Name
End Sub
```

**수동 확인 방법**:
1. 각 시트로 이동
2. **데이터** 탭 → **쿼리 및 연결** 옆 **▼** → **쿼리 및 연결** 클릭
3. "테이블" 섹션에서 테이블 이름 확인

**✅ 최종 성공 확인 체크리스트**:

| 시트 | 테이블 이름 | 헤더 개수 | 데이터 상태 |
|------|-------------|-----------|-------------|
| CoAMaster | Master | 11 | 빈 상태 (VBA가 채움) |
| CorpMaster | Corp | 10 | 빈 상태 (수동 입력) |
| CorpCoA | Raw_CoA | 9 | 빈 상태 (VBA가 채움) |
| BSPL | PTB | 8 | 빈 상태 (Power Query가 채움) |
| ADBS | AD_BS | 9 | 빈 상태 |
| HideSheet | 결산연월 | 2 | **2026, 1 입력됨** ✅ |
| HideSheet | Link | 2 | **SharePoint URL 입력됨** ✅ |
| HideSheet | 비경상적 | 2 | 빈 상태 |
| HideSheet | 환율마스터 | 2 | 빈 상태 |
| AddCoA | CoA_Input | 7 | 빈 상태 |
| AddCoA_ADBS | CoA_Input_ADBS | 7 | 빈 상태 |

---

## PART 2: VBA 및 리본 메뉴

## 5. VBA 모듈 임포트

### 5.1 VBA 편집기 열기

1. Excel 파일 (`연결마스터_HRE_v1.00.xlsm`) 열기
2. **Alt + F11** 누르기
3. 좌측 **프로젝트 탐색기**에서 **VBAProject (연결마스터_HRE_v1.00.xlsm)** 확인

**만약 프로젝트 탐색기가 안 보이면**:
- **보기** → **프로젝트 탐색기** (또는 **Ctrl + R**)

### 5.2 모듈 임포트 우선순위

**중요**: 모듈을 **반드시 아래 순서대로** 임포트하세요.
(mod_10_Public이 다른 모듈에서 참조되므로 먼저 임포트 필요)

#### 순서 1: 공통 유틸리티 (7개)

1. **mod_10_Public.bas** ⭐ 최우선
2. mod_Log.bas
3. mod_MouseWheel.bas
4. mod_QueryProtection.bas
5. mod_Refresh.bas
6. mod_OpenPage.bas
7. mod_z_Module_GetCursor.bas

**임포트 방법**:
1. VBA 편집기에서 **파일** → **파일 가져오기**
2. `/Users/jaewookim/Desktop/Project/HRE/작업/VBA_Export/` 폴더로 이동
3. **mod_10_Public.bas** 선택 → **열기**
4. 프로젝트 탐색기에서 **모듈** 폴더 아래에 "mod_10_Public" 추가 확인
5. 나머지 6개 파일도 동일하게 진행

**✅ 성공 확인**:
- 프로젝트 탐색기 → **모듈** 폴더 → 7개 모듈 표시

#### 순서 2: 워크플로 모듈 (9개)

8. mod_01_FilterSearch.bas
9. mod_02_FilterSearch_Master.bas
10. **mod_03_PTB_CoA_Input.bas** ⭐ 변종 인식 핵심
11. mod_04_IntializeProgress.bas
12. mod_05_PTB_Highlight.bas
13. mod_06_VerifySum.bas
14. mod_09_CheckMaster.bas
15. mod_11_Sync.bas
16. mod_16_Export.bas

**동일한 방법으로 임포트**

#### 순서 3: HRE 신규 모듈 (2개)

17. **mod_17_ExchangeRate.bas** ⭐ 환율 조회 핵심
18. **Setup_CoAMaster.bas** ⭐ CoA 마스터 데이터 로드

#### 순서 4: 리본 및 기타 (2개)

19. **mod_Ribbon.bas** (리본 콜백)
20. Module1.bas (VBA 내보내기 도구)

**✅ 성공 확인 (순서 1-4 완료 후)**:
- **모듈** 폴더에 총 **20개 모듈** 표시
- 각 모듈 더블클릭 시 코드 창 열림

#### ⭐ 중요: 인코딩 및 B열 레이아웃 업데이트 정보

**이미 수정 완료된 파일** (VBA_Export 폴더 내):

다음 5개 파일은 **B열 레이아웃 및 UTF-8 인코딩 적용 완료** 상태입니다:

| 파일 | 수정 내용 |
|------|----------|
| **mod_03_PTB_CoA_Input.bas** | Line 326: A1→B1 시트 선택 코드 수정 |
| **mod_05_PTB_Highlight.bas** | Lines 138,147,150,168: A1→B1 수정 (4곳) |
| **mod_06_VerifySum.bas** | Line 541: A1→B1 수정 |
| **mod_16_Export.bas** | Line 64: A1→B1 수정 |
| **CoAMaster_code.bas** | CP949→UTF-8 인코딩 변환 완료 |

**예외 파일**:
- **mod_17_ExchangeRate.bas**: 15개 A1 참조 유지 (HideSheet 환율 테이블용, 정상)

**검증 완료**:
- ✅ 34개 VBA 파일 모두 UTF-8 인코딩
- ✅ HideSheet 제외 모든 시트 B열 레이아웃 적용
- ✅ 인코딩 깨짐 현상(����) 없음

### 5.3 워크시트 코드 모듈 임포트 (14개)

**중요**: 워크시트 코드 모듈은 **VBA 클래스 모듈**로, 각 시트와 연결됩니다.

#### 임포트 방법:

1. **파일** → **파일 가져오기**
2. **현재_통합_문서_code.bas** 선택 → **열기**
3. 프로젝트 탐색기에서 **Microsoft Excel 개체** 폴더 확인
4. **ThisWorkbook** 객체 더블클릭 → 코드 창에 내용 표시 확인

**나머지 13개 파일도 동일하게 임포트**:

| 파일 이름 | 연결 대상 |
|-----------|-----------|
| 현재_통합_문서_code.bas | ThisWorkbook |
| CoAMaster_code.bas | CoAMaster 시트 |
| CorpMaster_code.bas | CorpMaster 시트 |
| CorpCoA_code.bas | CorpCoA 시트 |
| BSPL_code.bas | BSPL 시트 |
| ADBS_code.bas | ADBS 시트 |
| Verify_code.bas | Verify 시트 |
| Check_code.bas | Check 시트 |
| Guide_code.bas | Guide 시트 |
| HideSheet_code.bas | HideSheet 시트 |
| DirectoryURL_code.bas | DirectoryURL 시트 |
| Memo_code.bas | Memo 시트 |
| AddCoA_code.bas | AddCoA 시트 |
| AddCoA_ADBS_code.bas | AddCoA_ADBS 시트 |

**✅ 성공 확인**:
- **Microsoft Excel 개체** 폴더에 14개 시트 + ThisWorkbook = 총 15개
- 각 시트 더블클릭 시 코드 창에 내용 표시

### 5.4 VBA 프로젝트 컴파일

**모든 모듈 임포트 완료 후 필수 단계**:

1. VBA 편집기에서 **디버그** → **VBAProject 컴파일**
2. 오류 없이 완료 → ✅ 성공
3. 오류 발생 시:
   - 오류 메시지의 모듈 이름 확인
   - 해당 모듈 코드에서 빨간색 줄 표시된 부분 확인
   - [15. 문제 해결 가이드](#15-문제-해결-가이드) 참조

**일반적인 컴파일 오류**:

| 오류 메시지 | 원인 | 해결 방법 |
|-------------|------|-----------|
| "Sub 또는 Function이 정의되지 않았습니다" | 모듈 누락 | 누락된 모듈 재임포트 |
| "형식이 일치하지 않습니다" | 테이블 이름 오타 | 테이블 이름 재확인 |
| "개체가 필요합니다" | 시트 또는 테이블 누락 | 3-4장 시트/테이블 생성 재확인 |

**✅ 최종 성공 확인**:
- 컴파일 완료 후 오류 없음
- 프로젝트 탐색기에 총 **20개 모듈 + 15개 시트** = **35개 항목**

---

## 6. UserForm 임포트

### 6.1 UserForm이란?

VBA에서 사용하는 **대화상자 창**입니다.
- 데이터 입력, 설정 변경, 필터링 등에 사용
- `.frm` (코드) + `.frx` (디자인 바이너리) 파일 쌍으로 구성

### 6.2 UserForm 임포트 방법

#### 단계 1: 임포트

1. VBA 편집기에서 **파일** → **파일 가져오기**
2. `/Users/jaewookim/Desktop/Project/HRE/작업/UserForms/` 폴더로 이동
3. **frmCalendar.frm** 선택 → **열기**
   - **중요**: .frx 파일도 같은 폴더에 있어야 자동으로 임포트됨
4. 프로젝트 탐색기에서 **폼** 폴더 아래에 "frmCalendar" 추가 확인

#### 단계 2: 모든 UserForm 임포트

**총 16개 UserForm**:

| 파일 이름 | 용도 |
|-----------|------|
| frmCalendar.frm | 날짜 선택기 |
| FrmProgress.frm | 진행률 표시 |
| frmFilter.frm | PTB 필터링 |
| frmFilter_Master.frm | 마스터 필터링 |
| frmSPO.frm | SharePoint URL 설정 |
| frmDate.frm | 결산연월 설정 |
| frmScope.frm | 연결범위 설정 |
| frmDirectory.frm | 부서 관리 |
| frmAddPerson.frm | 사용자 추가 |
| frmEditPerson.frm | 사용자 수정 |
| frmPeople.frm | 사용자 관리 메인 |
| frmCorp_Append.frm | 법인 추가 |
| frmCorp_Alter.frm | 법인 수정 |
| frmCoA_Update.frm | CoA 일괄 업데이트 |
| frmCoA_Alter.frm | CoA 개별 수정 |
| frmCoA_Delete.frm | CoA 삭제 |

**⚠️ 주의**: `Unused_` 접두사가 붙은 폼은 임포트하지 마세요 (사용 안 함).

#### 단계 3: 임포트 확인

1. 프로젝트 탐색기 → **폼** 폴더
2. 총 **16개 폼** 표시 확인
3. 각 폼 더블클릭 → 디자인 창 열림 확인

**✅ 성공 확인**:
- 폼 폴더에 16개 UserForm
- 각 폼 열렸을 때 버튼, 텍스트박스 등 컨트롤 표시

### 6.3 UserForm 테스트

**간단 테스트**:

1. VBA 편집기에서 **삽입** → **모듈** → 임시 모듈 생성
2. 아래 코드 입력:
```vba
Sub TestFrmCalendar()
    frmCalendar.Show
End Sub
```
3. 커서를 코드 안에 놓고 **F5** 실행
4. 달력 폼 표시 → ✅ 정상
5. 테스트 완료 후 임시 모듈 삭제

---

## 7. 리본 메뉴 설치

### 7.1 리본 메뉴란?

Excel 상단의 **"연결마스터"** 탭으로, 23개 버튼을 포함합니다.

**리본 구조**:
```
[연결마스터 탭]
  - [설정] 그룹: SPO 설정, 조직 설정, 결산연월 설정, 법인 추가, 연결범위 설정
  - [환율] 그룹: 평균환율 조회, 기말환율 조회
  - [계정과목] 그룹: CoA 확인 및 데이터 합산, CoA 동기화
  - [검증] 그룹: 재무제표 검증, 취득/처분 검증, 마스터 검증
  - [유틸리티] 그룹: 필터, 필터 해제, 쿼리 잠금, 쿼리 해제, 사용자 관리
  - [내보내기] 그룹: 파일 내보내기
  - [정보] 그룹: 버전 정보, SPO 사이트, 사용 설명서, 버그 리포트
```

### 7.2 Custom UI Editor 설치 (사전 준비)

[2.3 다운로드 도구](#23-다운로드-도구)에서 이미 설치 완료 확인

### 7.3 Ribbon XML 추가

#### 단계 1: Custom UI Editor에서 파일 열기

1. **Custom UI Editor** 실행
2. **File** → **Open**
3. `연결마스터_HRE_v1.00.xlsm` 선택 → **Open**

**⚠️ 주의**: Excel에서 파일이 열려있으면 닫으세요. (동시에 열 수 없음)

#### 단계 2: Custom UI Part 추가

1. **Insert** → **Office 2010 Custom UI Part**
2. 좌측 트리에 **customUI14.xml** 생성 확인

#### 단계 3: XML 코드 붙여넣기

우측 편집기에 아래 XML 전체를 붙여넣으세요:

```xml
<customUI xmlns="http://schemas.microsoft.com/office/2009/07/customui">
  <ribbon>
    <tabs>
      <tab id="tab_HRE" label="연결마스터" insertAfterMso="TabHome">

        <!-- 설정 그룹 -->
        <group id="grp_Setup" label="설정">
          <button id="btn_SetSPO" label="SPO 설정" imageMso="DatabaseAccess" onAction="SetSPO" />
          <button id="btn_SetDirectory" label="조직 설정" imageMso="OrganizationChart" onAction="SetDirectory" />
          <button id="btn_SetDate" label="결산연월 설정" imageMso="DateAndTime" onAction="SetDate" />
          <button id="btn_AppendCorp" label="법인 추가" imageMso="TableInsertRow" onAction="AppendCorp" />
          <button id="btn_SetScope" label="연결범위 설정" imageMso="FilterAdvanced" onAction="SetScope" />
        </group>

        <!-- 환율 그룹 (HRE 신규) -->
        <group id="grp_Exchange" label="환율">
          <button id="btn_GetERFlow" label="평균환율 조회" imageMso="CalculateFx" onAction="GetER_Flow" />
          <button id="btn_GetERSpot" label="기말환율 조회" imageMso="CalculateFx" onAction="GetER_Spot" />
        </group>

        <!-- 계정과목 그룹 -->
        <group id="grp_CoA" label="계정과목">
          <button id="btn_Update" label="CoA 확인 및&#xA;데이터 합산" imageMso="RefreshData" onAction="Update" size="large" />
          <button id="btn_SyncCoA" label="CoA 동기화" imageMso="SynchronizeList" onAction="Synchro_CoA" />
        </group>

        <!-- 검증 그룹 -->
        <group id="grp_Verify" label="검증">
          <button id="btn_VerifyBSPL" label="재무제표 검증" imageMso="TableCheckForDuplicates" onAction="Verify_BSPL" />
          <button id="btn_VerifyAD" label="취득/처분 검증" imageMso="TableCheckForDuplicates" onAction="Verify_AD" />
          <button id="btn_VerifyMaster" label="마스터 검증" imageMso="TableCheckForDuplicates" onAction="Verify_Master" />
        </group>

        <!-- 유틸리티 그룹 -->
        <group id="grp_Utility" label="유틸리티">
          <button id="btn_FilterSheet" label="필터" imageMso="FilterMenu" onAction="FilterSheet" />
          <button id="btn_UnfilterSheet" label="필터 해제" imageMso="FilterClearAllFilters" onAction="UnfilterSheet" />
          <button id="btn_ProtectQuery" label="쿼리 잠금" imageMso="Lock" onAction="ProtectQuery" />
          <button id="btn_UnprotectQuery" label="쿼리 해제" imageMso="Unlock" onAction="UnprotectQuery" />
          <button id="btn_ManagePeople" label="사용자 관리" imageMso="PeopleTeamWorkspace" onAction="Manage_People" />
        </group>

        <!-- 내보내기 그룹 -->
        <group id="grp_Export" label="내보내기">
          <button id="btn_Export" label="파일 내보내기" imageMso="ExportExcel" onAction="Export_File" size="large" />
        </group>

        <!-- 정보 그룹 -->
        <group id="grp_Info" label="정보">
          <button id="btn_Version" label="버전 정보" imageMso="Info" onAction="IRVersion" />
          <button id="btn_SPOSite" label="SPO 사이트" imageMso="WebPage" onAction="IRSPO" />
          <button id="btn_Manual" label="사용 설명서" imageMso="Help" onAction="IRManual" />
          <button id="btn_BugReport" label="버그 리포트" imageMso="ReportBug" onAction="IRBugReport" />
        </group>

      </tab>
    </tabs>
  </ribbon>
</customUI>
```

#### 단계 4: XML 검증

1. **Validate** 버튼 (녹색 체크 아이콘) 클릭
2. 하단에 **"No errors found"** 메시지 확인 → ✅ 정상
3. 오류 발생 시:
   - 오류 행 번호 확인
   - XML 태그 닫힘 여부 확인 (`<button ... />` 끝에 `/` 필수)
   - 따옴표 누락 확인

#### 단계 5: 저장 및 종료

1. **File** → **Save**
2. Custom UI Editor 종료
3. Excel에서 파일 다시 열기

**✅ 성공 확인**:
1. Excel 상단에 **"연결마스터"** 탭 표시
2. 탭 클릭 → 7개 그룹 (설정, 환율, 계정과목, 검증, 유틸리티, 내보내기, 정보) 표시
3. 각 그룹 내 버튼들 표시

### 7.4 리본 메뉴 테스트

#### 기본 테스트:

1. **연결마스터** 탭 → **정보** 그룹 → **버전 정보** 버튼 클릭
2. 메시지 박스 표시:
   ```
   현재 버전: 1.00
   배포일: 2026-01-21
   만료일: 2030-12-31
   ```
3. **확인** → ✅ 정상

#### 환율 버튼 테스트:

1. **환율** 그룹 → **평균환율 조회** 버튼 클릭
2. frmCalendar 폼 표시 (시작일 선택)
3. **취소** 클릭하여 폼 닫기
4. 오류 없이 종료 → ✅ 정상

**⚠️ 참고**: 실제 환율 조회는 SharePoint 연결 후 테스트 (13장)

---

## PART 3: 데이터 연결

## 8. SharePoint 폴더 구조 생성

### 8.1 SharePoint 사이트 접속

1. 브라우저(Chrome, Edge 권장)에서 아래 URL 접속:
   ```
   https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation
   ```
2. Office 365 계정으로 로그인

**✅ 성공 확인**:
- 사이트 제목 "KR-ASR-HRE_Consolidation" 표시
- 좌측 메뉴에서 **Documents** 항목 확인

### 8.2 폴더 구조 생성

#### 전체 구조 (연도 → 법인명 순서):

```
KR-ASR-HRE_Consolidation/
└── Documents/
    ├── ★시연용폴더★/               (또는 Financial Data)
    │   ├── {결산연월}/              (예: 2512 = 2025년 12월)
    │   │   ├── {법인명}/            (예: HRE, 예천솔라)
    │   │   │   └── *시산표*.xlsx    (파일명에 "시산표" 포함)
    │   │   ├── {법인명}/
    │   │   │   └── *시산표*.xlsx
    │   │   └── ...
    │   │
    │   └── {결산연월}/              (예: 2603 = 2026년 3월)
    │       └── (동일 구조)
    │
    ├── CoA_Master/                  (CoA 마스터 저장)
    │   └── HRE_CoA_Master_v1.00.xlsx
    │
    └── Archive/                     (과거 데이터 보관)
        └── ...
```

#### 실제 예시:

```
★시연용폴더★/
└── 2512/                           ← 2025년 12월 결산
    ├── HRE/
    │   └── 12월 말 합계잔액시산표_에이치알이_수정.xlsx
    ├── 예천솔라/
    │   └── 12월 말 합계잔액시산표_예천솔라.xlsx
    └── 태양광1호/
        └── 시산표_태양광1호_2512.xlsx
```

**⚠️ 중요 규칙**:
- **폴더 순서**: `{결산연월}/{법인명}/` (연도-월 → 법인명 순서)
- **파일명 규칙**: 파일명에 **"시산표"** 텍스트 포함 필수
- **폴더당 파일 수**: 각 법인 폴더에 시산표 파일은 **1개만** 존재해야 함
- **여러 파일 시**: 시산표 파일이 2개 이상이면 Power Query에서 오류 발생 (VBA가 Alert 표시)

#### 단계별 생성:

**1단계: Documents 폴더에서 시작**

1. SharePoint 사이트 홈에서 **Documents** 클릭
2. 상단 **+ 새로 만들기** → **폴더**
3. 폴더 이름: `Financial Data` → **만들기**
4. 동일한 방법으로 `CoA_Master`, `Templates`, `Archive` 폴더 생성

**2단계: Financial Data 내부 구조**

1. **Financial Data** 폴더 클릭
2. **+ 새로 만들기** → **폴더** → `2026` 생성
3. **2026** 폴더 클릭
4. 법인별 폴더 생성:
   - `01_HRE-001_한국재생에너지`
   - `02_HRE-002_태양광1호`
   - `03_HRE-003_태양광2호`
   - ... (법인 수만큼)

**폴더 이름 규칙**:
```
{순번}_{법인코드}_{법인명}

예시:
01_HRE-001_한국재생에너지
02_HRE-002_태양광1호
10_HRE-010_풍력발전
```

**✅ 성공 확인**:
- Documents 폴더 아래 4개 폴더 (Financial Data, CoA_Master, Templates, Archive)
- Financial Data/2026 아래 법인별 폴더 N개

### 8.3 권한 설정

#### 기본 권한 (모든 PwC 사용자):

1. Documents 라이브러리 우측 상단 **⚙️** (설정) → **라이브러리 설정**
2. **이 문서 라이브러리에 대한 사용 권한** 클릭
3. **권한 부여** 클릭
4. 사용자/그룹 입력:
   ```
   pwc.com 전체 사용자
   ```
5. 권한 수준: **편집** 선택
6. **공유** 클릭

#### 법인별 폴더 권한 (선택사항):

특정 법인 폴더를 해당 법인 담당자만 볼 수 있도록 제한하려면:

1. 법인 폴더 (`01_HRE-001_한국재생에너지`) 우클릭 → **권한 관리**
2. **권한 상속 중지** 클릭
3. **권한 부여** → 담당자 이메일 입력 → **공유**

**권장 사항**: 초기 구축 시에는 모든 사용자에게 편집 권한 부여, 운영 단계에서 제한

**✅ 성공 확인**:
- Documents 폴더 공유 상태에서 "@pwc.com" 도메인 사용자 확인

### 8.4 SharePoint URL 복사

**중요**: Power Query 연결 시 정확한 URL이 필요합니다.

1. SharePoint에서 **Documents** 폴더 클릭
2. 브라우저 주소창의 URL 복사:
   ```
   https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation/Shared%20Documents
   ```
3. 메모장에 저장 (나중에 사용)

**표준 SharePoint URL 패턴**:
```
https://{테넌트}.sharepoint.com/sites/{사이트명}/Shared%20Documents
```

---

## 9. 시산표 파일 준비 및 업로드

### 9.1 시산표 파일 형식

#### 필수 구조:

**파일 형식**: Excel 파일 (.xlsx, .xlsm 모두 가능)
**시트 이름**: `시산표` (정확히 일치해야 함)

**필수 컬럼** (A1:F1):

| A1 | B1 | C1 | D1 | E1 | F1 |
|----|----|----|----|----|----|
| 법인코드 | 계정코드 | 계정과목명 | 차변 | 대변 | 기능통화 |

#### 컬럼 설명:

| 컬럼 | 데이터 타입 | 필수 여부 | 예시 | 설명 |
|------|-------------|-----------|------|------|
| 법인코드 | 텍스트 | 필수 | HRE-001 | CorpMaster의 법인코드와 일치 |
| 계정코드 | 텍스트 | 필수 | 10300, 11401_내부거래 | 5자리 + 선택적 접미사 |
| 계정과목명 | 텍스트 | 필수 | 당좌예금, 단기대여금(관계사) | |
| 차변 | 숫자 | 필수 | 1000000 | 0 이상 |
| 대변 | 숫자 | 필수 | 0 | 0 이상 |
| 기능통화 | 텍스트 | 선택 | KRW, USD, EUR | 빈칸이면 KRW로 간주 |

#### 샘플 데이터:

| 법인코드 | 계정코드 | 계정과목명 | 차변 | 대변 | 기능통화 |
|---------|---------|-----------|------|------|----------|
| HRE-001 | 10300 | 당좌예금 | 50000000 | 0 | KRW |
| HRE-001 | 10310 | 보통예금 | 120000000 | 0 | KRW |
| HRE-001 | 11401_내부거래 | 단기대여금(관계사) | 30000000 | 0 | KRW |
| HRE-001 | 21101 | 단기차입금 | 0 | 80000000 | KRW |
| HRE-002 | 10300 | Cash | 10000 | 0 | USD |

### 9.2 시산표 파일 생성 (예시)

#### 방법 1: 템플릿 사용

1. SharePoint **Templates** 폴더에서 `시산표_템플릿.xlsx` 다운로드
2. 법인 데이터 입력
3. **파일 → 다른 이름으로 저장**
   - 파일명: `시산표_HRE-001_202601.xlsx`
   - 위치: 로컬 폴더

#### 방법 2: 기존 시산표 변환

회계 시스템에서 추출한 시산표가 있는 경우:

1. Excel에서 열기
2. 새 시트 추가 → 이름을 `시산표`로 변경
3. A1:F1에 필수 컬럼 헤더 입력
4. 기존 데이터를 복사하여 붙여넣기
5. 컬럼 순서 및 형식 맞춤
6. 다른 시트 삭제 (시산표 시트만 남김)
7. 파일명 규칙에 맞게 저장

### 9.3 계정코드 변종 처리

**변종 접미사 규칙**:

| 접미사 | 의미 | Variant Type | 예시 |
|--------|------|--------------|------|
| (없음) | 일반 계정 | BASE | 10300 |
| _내부거래 | 한국어 내부거래 | INTERCO_KR | 11401_내부거래 |
| _IC | 영문 내부거래 (Intercompany) | INTERCO_IC | 11401_IC |

**중요**: Power Query는 모든 변종을 그대로 가져오고, VBA의 `mod_03_PTB_CoA_Input.bas`가 자동으로 감지합니다.

### 9.4 파일 업로드

#### 단계 1: SharePoint 폴더로 이동

1. SharePoint 사이트 접속
2. **Documents** → **Financial Data** → **2026** → **01_HRE-001_한국재생에너지**

#### 단계 2: 파일 업로드

1. **업로드** → **파일**
2. `시산표_HRE-001_202601.xlsx` 선택 → **열기**
3. 업로드 완료 확인

#### 단계 3: 모든 법인 파일 업로드

각 법인별 폴더에 해당 법인의 시산표 파일 업로드:

| 폴더 | 파일 이름 |
|------|-----------|
| 01_HRE-001_한국재생에너지 | 시산표_HRE-001_202601.xlsx |
| 02_HRE-002_태양광1호 | 시산표_HRE-002_202601.xlsx |
| 03_HRE-003_태양광2호 | 시산표_HRE-003_202601.xlsx |

**✅ 성공 확인**:
- 각 법인 폴더에 1개 시산표 파일 존재
- 파일 클릭 → Excel Online에서 열림
- 시산표 시트 존재, 데이터 정상

### 9.5 파일명 규칙 준수 중요성

**규칙**:
```
시산표_{법인코드}_{YYYYMM}.xlsx
```

**잘못된 예시**:
- ❌ `HRE-001_시산표_202601.xlsx` (순서 틀림)
- ❌ `시산표_HRE001_202601.xlsx` (하이픈 누락)
- ❌ `시산표_HRE-001_2026-01.xlsx` (날짜 형식 틀림)
- ❌ `시산표_HRE-001_202601.xlsm` (확장자는 .xlsx/.xlsm 모두 가능하지만 통일 권장)

**올바른 예시**:
- ✅ `시산표_HRE-001_202601.xlsx`
- ✅ `시산표_HRE-002_202601.xlsx`

**이유**: Power Query M 코드가 파일명 패턴으로 법인코드를 추출하기 때문에 규칙 준수 필수.

---

## 10. Power Query 연결 설정

### 10.1 Power Query란?

Excel의 **데이터 연결 및 변환 도구**로, SharePoint의 수십 개 시산표 파일을 자동으로 하나의 테이블로 병합합니다.

**워크플로**:
```
HideSheet 테이블 → Power Query M 코드 → SharePoint 데이터 → Excel 테이블
```

**⚠️ 중요**: Power Query는 HideSheet의 테이블(Path, TempPath, 결산연월)을 참조하여 동적으로 데이터를 가져옵니다. HideSheet 테이블 구조가 정확해야 합니다.

### 10.2 Power Query 아키텍처

#### 쿼리 의존성 관계

```
[HideSheet 테이블]
       │
       ├─→ 메인주소 (Path 테이블 참조)
       │      │
       │      └─→ 디렉터리 (폴더 목록)
       │
       ├─→ 회사결산 주소 (TempPath 테이블 참조)
       │      │
       │      └─→ Raw_Data (시산표 원본 데이터)
       │              │
       │              └─→ PTB (정제된 시산표)
       │
       └─→ 결산연월 참조 (연도/월 필터링)
```

#### 필수 쿼리 목록 (생성 순서)

| 순서 | 쿼리명 | 용도 | 로드 위치 |
|------|--------|------|-----------|
| 1 | 메인주소 | SPO 기본 URL | 연결 전용 |
| 2 | 회사결산 주소 | 선택된 폴더 경로 | 연결 전용 |
| 3 | 디렉터리 | 폴더 구조 (TreeView용) | DirectoryURL 시트 |
| 4 | Raw_Data | 시산표 원본 데이터 | 연결 전용 |
| 5 | PTB | 정제된 시산표 | BSPL 시트 |
| 6 | Corp | 법인 마스터 | 연결 전용 |
| 7 | Corp_Date | 법인별 결산일 | 연결 전용 |
| 8 | CoA | 계정과목 마스터 | 연결 전용 |
| 9 | CoA_Processed | 처리된 CoA | 연결 전용 |
| 10 | Master | 종합 마스터 | 연결 전용 |

### 10.3 쿼리 생성 - 기본 설정 쿼리

#### 쿼리 1: 메인주소

HideSheet의 Path 테이블에서 SPO URL을 읽어옵니다.

**생성 방법**:
1. **데이터** → **데이터 가져오기** → **기타 원본에서** → **빈 쿼리**
2. **홈** → **고급 편집기**
3. 아래 코드 붙여넣기:

```m
let
    경로 = Excel.CurrentWorkbook(){[Name="Path"]}[Content],
    메인주소 = 경로{0}[메인주소]
in
    메인주소
```

4. **홈** → **닫기 및 로드** → **닫기 및 로드 위치...**
5. **연결만 만들기** 선택
6. 쿼리 이름: `메인주소`

#### 쿼리 2: 회사결산 주소

HideSheet의 TempPath 테이블에서 선택된 폴더 경로를 읽어옵니다.

```m
let
    경로 = Excel.CurrentWorkbook(){[Name="TempPath"]}[Content],
    경로텍스트 = Text.From(경로{0}[경로])
in
    경로텍스트
```

**⚠️ 오류 해결**: `Expression.Error: 레코드의 '경로' 필드를 찾을 수 없습니다`
→ HideSheet의 TempPath 테이블 컬럼명이 `경로`인지 확인 (Temp4 등이면 수정 필요)

### 10.4 쿼리 생성 - 디렉터리 쿼리

frmDirectory TreeView에서 사용할 폴더 목록을 생성합니다.

```m
let
    주소 = 메인주소,
    Source = SharePoint.Files(주소, [ApiVersion = 15]),
    폴더추출 = Table.SelectColumns(Source,{"Folder Path"}),
    중복제거 = Table.Distinct(폴더추출),
    정렬 = Table.Sort(중복제거,{{"Folder Path", Order.Ascending}}),
    폴더경로추출 = Table.TransformColumns(정렬, {{"Folder Path", each Text.AfterDelimiter(_, 주소), type text}}),
    리스트화 = Table.RenameColumns(폴더경로추출,{{"Folder Path", "디렉터리"}})
in
    리스트화
```

**로드 위치**: DirectoryURL 시트 → `디렉터리` 테이블

### 10.5 쿼리 생성 - 데이터 쿼리

#### 쿼리 4: Raw_Data

SharePoint에서 시산표 파일을 읽어 원본 데이터를 가져옵니다.

```m
let
    회사결산주소 = 회사결산_주소,
    시트이름 = "시산표",
    Source = SharePoint.Files(메인주소, [ApiVersion = 15]),
    경로필터 = Table.SelectRows(Source, each Text.Contains([Folder Path], 회사결산주소)),
    폴더경로추출 = Table.AddColumn(경로필터, "법인코드", each
        let
            path = [Folder Path],
            afterMain = Text.AfterDelimiter(path, 회사결산주소),
            segments = Text.Split(afterMain, "/"),
            corpFolder = List.First(List.Select(segments, each Text.Contains(_, "[") and Text.Contains(_, "]")))
        in
            if corpFolder <> null then Text.BetweenDelimiters(corpFolder, "[", "]") else null
    ),
    법인필터 = Table.SelectRows(폴더경로추출, each [법인코드] <> null),
    엑셀로드 = Table.AddColumn(법인필터, "ExcelData", each
        try Excel.Workbook([Content], true){[Item=시트이름, Kind="Sheet"]}[Data]
        otherwise null
    ),
    유효데이터 = Table.SelectRows(엑셀로드, each [ExcelData] <> null),
    확장 = Table.ExpandTableColumn(유효데이터, "ExcelData", {"계정코드", "계정과목명", "차변", "대변"}, {"계정코드", "계정과목명", "차변", "대변"}),
    타입변환 = Table.TransformColumnTypes(확장, {
        {"계정코드", type text},
        {"계정과목명", type text},
        {"차변", type number},
        {"대변", type number},
        {"법인코드", type text}
    }),
    컬럼선택 = Table.SelectColumns(타입변환, {"법인코드", "계정코드", "계정과목명", "차변", "대변"})
in
    컬럼선택
```

**로드**: 연결 전용

#### 쿼리 5: PTB

Raw_Data를 정제하여 BSPL 시트에 로드합니다.

```m
let
    Source = Raw_Data,
    차변대변계산 = Table.AddColumn(Source, "차변-대변", each [차변] - [대변], type number),
    PwCCoA추가 = Table.AddColumn(차변대변계산, "PwC_CoA", each null, type text),
    PwC계정명추가 = Table.AddColumn(PwCCoA추가, "PwC_계정과목명", each null, type text),
    컬럼정렬 = Table.SelectColumns(PwC계정명추가, {"법인코드", "계정코드", "계정과목명", "차변", "대변", "차변-대변", "PwC_CoA", "PwC_계정과목명"})
in
    컬럼정렬
```

**로드 위치**: BSPL!$B$5 → `PTB` 테이블

### 10.6 쿼리 생성 - 마스터 쿼리

#### 쿼리 6: Corp (법인 마스터)

```m
let
    Source = Excel.CurrentWorkbook(){[Name="Corp"]}[Content],
    타입변환 = Table.TransformColumnTypes(Source, {
        {"법인코드", type text},
        {"법인명", type text},
        {"기능통화", type text}
    })
in
    타입변환
```

#### 쿼리 7: CoA (계정과목 마스터)

```m
let
    Source = Excel.CurrentWorkbook(){[Name="Master"]}[Content],
    타입변환 = Table.TransformColumnTypes(Source, {
        {"Account", type text},
        {"PwC CoA Description", type text},
        {"BS_PL", type text}
    })
in
    타입변환
```

### 10.7 쿼리 로드 설정

#### 각 쿼리별 로드 위치

| 쿼리명 | 로드 방식 | 위치 |
|--------|----------|------|
| 메인주소 | 연결 전용 | - |
| 회사결산 주소 | 연결 전용 | - |
| 디렉터리 | 테이블 | DirectoryURL!$A$1 |
| Raw_Data | 연결 전용 | - |
| PTB | 테이블 | BSPL!$B$5 |
| Corp | 연결 전용 | - |
| CoA | 연결 전용 | - |

### 10.8 SharePoint 폴더 구조 요구사항

**신규 폴더 구조** (연도 → 법인명 순서):

```
★시연용폴더★/
└── 2512/                        ← 결산연월 (TempPath.경로에 저장)
    ├── HRE/                     ← 법인명 폴더
    │   └── *시산표*.xlsx        ← 파일명에 "시산표" 포함
    ├── 예천솔라/
    │   └── *시산표*.xlsx
    └── 태양광1호/
        └── *시산표*.xlsx
```

**⚠️ 중요 규칙**:
- **폴더 순서**: `{결산연월}/{법인명}/` (기존 `{법인명}/{결산연월}/`과 반대)
- **파일명 규칙**: 파일명에 **"시산표"** 텍스트 포함 필수
- **폴더당 파일 수**: 각 법인 폴더에 시산표 파일은 **1개만** 존재해야 함
- **법인코드 추출**: 결산연월 폴더 바로 아래의 폴더명이 법인코드로 사용됨

### 10.9 쿼리 새로고침

#### 수동 새로고침:

1. **데이터** 탭 → **모두 새로 고침**
2. 또는 BSPL 시트에서 PTB 테이블 내 우클릭 → **새로 고침**

#### VBA 자동 새로고침:

`mod_08_QueryRefresh.bas`의 `QueryRefresh()` 함수가 호출됩니다.

```vba
' VBA에서 Power Query 새로고침
ThisWorkbook.Connections("쿼리 - PTB").Refresh
```

### 10.10 문제 해결

#### 오류 1: '경로' 필드를 찾을 수 없습니다

**원인**: HideSheet의 TempPath 테이블 컬럼명이 잘못됨
**해결**: TempPath 테이블 헤더를 `이름`, `구분`, `Description`, `경로`로 수정

#### 오류 2: 메인주소 쿼리 오류

**원인**: Path 테이블이 없거나 `메인주소` 컬럼이 없음
**해결**: HideSheet에 Path 테이블 생성, 컬럼명 `메인주소` 확인

#### 오류 3: SharePoint 인증 실패

**원인**: Office 365 계정 인증 필요
**해결**: Power Query 편집기 → **홈** → **데이터 원본 설정** → 조직 계정 로그인

#### 오류 4: 법인코드가 null

**원인**: SharePoint 폴더명에 `[법인코드]` 패턴이 없음
**해결**: 폴더명을 `[HRE-KR01]` 형식으로 변경

### 10.11 상세 문서 참조

전체 Power Query M 코드 및 상세 설명은 별도 문서를 참조하세요:

📄 **`PowerQuery/HRE_PowerQuery_전체.md`**

이 문서에는 다음 내용이 포함됩니다:
- 모든 쿼리의 전체 M 코드
- HideSheet 테이블 구조 상세 정의
- 쿼리 의존성 다이어그램
- 고급 문제 해결 가이드

---

## 11. CoA 마스터 데이터 로드

### 11.1 Setup_CoAMaster.bas 실행

#### 단계 1: VBA 편집기 열기

1. **Alt + F11**
2. 프로젝트 탐색기 → **모듈** → **Setup_CoAMaster** 더블클릭

#### 단계 2: 코드 실행

1. 코드 창에서 `Sub LoadCoAMaster()` 찾기
2. 커서를 Sub 내부에 놓기
3. **F5** (또는 **실행** → **Sub/사용자 폼 실행**)

**실행 결과**:
- 진행률 폼 표시
- "CoA 마스터 데이터 로드 중..." 메시지
- 완료 후 메시지 박스: "CoA 마스터 178개 계정이 로드되었습니다."

#### 단계 3: 데이터 확인

1. CoAMaster 시트로 이동
2. Master 테이블에 178개 행 데이터 채워짐 확인

**샘플 데이터**:

| Account | Description | 연결계정명 | BSPL | Ranking |
|---------|-------------|-----------|------|---------|
| 110110 | Cash and cash equivalents | 현금및현금성자산 | BS | 110 |
| 110120 | Short-term financial instruments | 단기금융상품 | BS | 120 |
| 115401 | Short-term loans to related parties | 단기대여금(관계사) | BS | 540 |

**✅ 성공 확인**:
- CoAMaster 시트에 178개 행 (+ 헤더 1개 = 179개 행)
- Account 컬럼이 6자리 숫자 (110110, 115401 등)
- BSPL 컬럼이 BS/IS/지분 값

### 11.2 Raw_CoA 초기 데이터 생성

Raw_CoA는 **CoA 매핑 이력**을 저장하는 테이블로, 초기에는 **표준 법인 코드(1000)의 기본 매핑**만 저장합니다.

#### VBA 코드 실행:

Setup_CoAMaster.bas 파일에 아래 함수가 포함되어 있으면 실행:

```vba
Sub LoadRawCoA_Initial()
    ' coa.md 파일을 파싱하여 Raw_CoA 테이블에 초기 데이터 삽입
End Sub
```

**만약 함수가 없으면**: 수동으로 Excel에서 데이터 입력 또는 coa.md 파일에서 복사

**✅ 성공 확인**:
- CorpCoA 시트의 Raw_CoA 테이블에 데이터 채워짐
- 법인코드 "1000" (표준 코드)
- Variant Type 컬럼에 BASE, INTERCO_KR, INTERCO_IC 값 존재

---

## 12. 전체 워크플로 테스트

### 12.1 워크플로 12단계 개요

Check 시트의 12단계를 순서대로 실행합니다.

| 단계 | 작업명 | 설명 | 예상 소요 시간 |
|------|--------|------|----------------|
| 1 | SPO 설정 | SharePoint URL 설정 | 1분 |
| 2 | 조직 설정 | 부서 코드 설정 | 2분 |
| 3 | 결산연월 설정 | 2026년 1월 설정 | 1분 |
| 4 | 법인 추가 | 대상 법인 등록 | 5분 |
| 5 | 연결범위 설정 | Scope 지정 | 2분 |
| 6 | CoA 마스터 검토 | 178개 계정 확인 | 5분 |
| 7 | CoA 확인 및 데이터 합산 | PTB 데이터 로드 | 3분 |
| 8 | CoA 추가/수정/삭제 | 매핑 완료 | 10분 |
| 9 | **환율 조회** | 평균/기말 환율 조회 | 2분 |
| 10 | 합산 검증 | 차변=대변 검증 | 3분 |
| 11 | 취득/처분 CoA 확인 | ADBS 데이터 로드 | 3분 (선택) |
| 12 | 취득/처분 검증 | ADBS 검증 | 2분 (선택) |

**총 소요 시간**: 약 40분

### 12.2 단계 1-6: 초기 설정

#### 단계 1: SPO 설정

1. **연결마스터** 탭 → **설정** 그룹 → **SPO 설정** 버튼 클릭
2. frmSPO 폼 표시
3. SharePoint URL 입력:
   ```
   https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation
   ```
4. **확인** 클릭

**✅ 성공 확인**:
- HideSheet의 Link 테이블에 URL 저장됨
- Check 시트 D12 셀에 "Complete" 표시

#### 단계 2-5: 조직, 결산연월, 법인, 연결범위 설정

동일한 방법으로 각 설정 버튼 클릭하여 폼에서 데이터 입력

#### 단계 6: CoA 마스터 검토

1. CoAMaster 시트로 이동
2. Master 테이블 데이터 확인 (178개 행)
3. Check 시트에서 수동으로 D17 셀에 "Complete" 입력

### 12.3 단계 7: CoA 확인 및 데이터 합산

**핵심 단계**: PTB 데이터를 로드하고 노란색 강조 표시합니다.

#### 실행:

1. **연결마스터** 탭 → **계정과목** 그룹 → **CoA 확인 및 데이터 합산** 버튼 클릭
2. 진행률 폼 표시: "쿼리 새로고침 중..."
3. PTB 테이블 새로고침 완료
4. "PTB 강조 표시 중..." 메시지
5. 완료 후 BSPL 시트 활성화

**✅ 성공 확인**:
- BSPL 시트의 PTB 테이블에 데이터 채워짐
- **노란색 배경** 행 표시 (PwC_CoA가 빈 행 = 매핑 필요)
- 전역 변수 `isYellow` 값 > 0 (VBA 즉시 실행 창에서 `? isYellow` 입력하여 확인)

#### 노란색 행 의미:

**법인별 CoA → PwC CoA 매핑이 아직 안 된 계정**입니다.
- 다음 단계(8단계)에서 매핑을 완료해야 합니다.

### 12.4 단계 8: CoA 추가/수정/삭제

#### First Drafting (자동 제안):

1. BSPL 시트에서 노란색 행 우클릭 → **CoA 추가** (또는 시트 탭 우클릭)
2. AddCoA 시트 활성화
3. CoA_Input 테이블 자동 채워짐:
   - A컬럼: 법인코드
   - B컬럼: 법인별CoA (계정코드)
   - C컬럼: 법인별계정과목명
   - **D컬럼: PwC_CoA (자동 제안됨)** ⭐
   - **E컬럼: PwC_계정과목명 (자동 제안됨)** ⭐

#### 자동 제안 로직:

VBA의 `Fill_Input_Table()` 함수가 실행되어:
1. 계정코드에서 **첫 5자리 추출** (예: `10300`)
2. 변종 타입 감지 (예: `11401_내부거래` → INTERCO_KR)
3. Raw_CoA 딕셔너리에서 매칭 검색:
   - **우선 1**: 정확한 변종 매칭 (예: INTERCO_KR)
   - **우선 2**: BASE 변종으로 폴백
4. 매칭 결과를 D, E 컬럼에 자동 입력

#### 수동 검토 및 수정:

1. D, E 컬럼의 제안값 확인
2. **노란색 배경** 셀 = 자동 제안 실패 → 수동 입력 필요
3. CoAMaster 시트 참조하여 올바른 PwC_CoA 선택
4. 모든 행의 D, E 컬럼 채워짐 확인

#### 최종 확정:

1. AddCoA 시트 하단 **"CoA 추가 완료"** 버튼 클릭 (또는 우클릭 메뉴)
2. VBA `Fill_CoA_Table()` 함수 실행
3. 검증:
   - D, E 컬럼 빈 셀 있으면 노란색 표시 + 오류 메시지
   - 모두 채워지면 CorpCoA의 Raw_CoA 테이블에 추가
4. BSPL 시트로 돌아감
5. PTB 테이블의 PwC_CoA, PwC_계정과목명 컬럼 자동 채워짐
6. **녹색 배경** 행으로 변경 → ✅ 매핑 완료

**✅ 성공 확인**:
- BSPL PTB 테이블에 노란색 행 없음 (모두 녹색)
- CorpCoA Raw_CoA 테이블에 매핑 이력 저장됨

---

## 13. 환율 조회 테스트

### 13.1 평균환율 조회 (P&L용)

#### 실행:

1. **연결마스터** 탭 → **환율** 그룹 → **평균환율 조회** 버튼 클릭
2. frmCalendar 폼 표시: "시작일을 선택하세요."
3. **2026-01-01** 선택 → **확인**
4. frmCalendar 폼 다시 표시: "종료일을 선택하세요."
5. **2026-01-21** 선택 → **확인**

#### 처리 과정:

1. VBA가 KEB 하나은행 API에 HTTP POST 요청
2. HTML 응답 수신 및 파싱
3. 클립보드로 테이블 복사
4. 새 시트 생성: **"환율정보(평균)"**
5. A4 셀에 테이블 붙여넣기
6. B, C 컬럼에 통화 코드 및 환산 정보 추가
7. JPY, VND, IDR은 환산=100, 나머지는 환산=1
8. 마지막 행에 KRW 기준선 추가 (환산=1, rate=1)

**✅ 성공 확인**:
- 새 시트 "환율정보(평균)" 생성
- A1 셀: 조회 기간 표시
- B5 셀: "통화" 헤더
- B8 이하: USD, EUR, JPY, CNY 등 통화 코드
- K 컬럼: 평균환율 (숫자)
- 마지막 행: "대한민국 KRW", 통화=KRW, 환산=1, 환율=1

#### 샘플 데이터:

| 국가명 및 통화 | 통화 | 환산 | ... | 평균환율 |
|---------------|------|------|-----|----------|
| 미국 USD | USD | 1 | ... | 1320.50 |
| 유럽연합 EUR | EUR | 1 | ... | 1450.20 |
| 일본 JPY | JPY | 100 | ... | 920.30 |
| 대한민국 KRW | KRW | 1 | ... | 1.00 |

### 13.2 기말환율 조회 (B/S용)

동일한 방법으로 **기말환율 조회** 버튼 클릭:

1. 날짜 선택: **2026-01-21** (단일 날짜)
2. 새 시트 생성: **"환율정보(일자)"**
3. 구조는 환율정보(평균)과 동일

**✅ 성공 확인**:
- "환율정보(일자)" 시트 생성
- 단일 날짜의 spot rate 표시

### 13.3 환율 데이터 활용

**재무제표에서 환율 적용 예시**:

```excel
// BSPL 시트에서 환율 변환 공식 (예시)
=차변 * XLOOKUP(기능통화, 환율정보(일자)[통화], 환율정보(일자)[기말환율], , 0)
```

**참고**: 실제 공식은 VBA가 피벗 테이블과 함께 자동 생성합니다.

### 13.4 Check 시트 상태 업데이트

VBA의 `UpdateCheckStatus()` 함수가 자동으로 실행되어:
- Check 시트 D20 셀에 "Complete" 입력
- E20 셀에 작업일시 입력
- F20 셀에 작업자 입력

**✅ 성공 확인**:
- Check 시트의 9단계 (환율 조회) 행이 녹색 배경

---

## 14. 최종 검증 체크리스트

### 14.1 VBA 코드 검증

#### ✅ 컴파일 오류 없음

1. **Alt + F11** → VBA 편집기
2. **디버그** → **VBAProject 컴파일**
3. 오류 없이 완료 → ✅

#### ✅ 전역 상수 확인

```vba
Sub CheckConstants()
    Debug.Print "AppName: " & AppName  ' "HRE"
    Debug.Print "AppVersion: " & AppVersion  ' "1.00"
    Debug.Print "PASSWORD: " & PASSWORD  ' "BEP1234"
End Sub
```

### 14.2 Excel 구조 검증

#### ✅ 시트 개수 및 순서

```
총 13개 시트 (또는 15개, 환율 시트 포함 시):
1. Guide
2. CoAMaster
3. CorpMaster
4. CorpCoA
5. BSPL
6. ADBS
7. Verify
8. Check
9. (숨김) HideSheet
10. (숨김) DirectoryURL
11. (숨김) Memo
12. (숨김 또는 표시) AddCoA
13. (숨김 또는 표시) AddCoA_ADBS
14. (선택) 환율정보(평균)
15. (선택) 환율정보(일자)
```

#### ✅ 테이블 존재 확인

VBA 즉시 실행 창:
```vba
Sub CheckAllTables()
    On Error Resume Next
    Debug.Print CoAMaster.ListObjects("Master").Name  ' "Master"
    Debug.Print CorpMaster.ListObjects("Corp").Name  ' "Corp"
    Debug.Print CorpCoA.ListObjects("Raw_CoA").Name  ' "Raw_CoA"
    Debug.Print BSPL.ListObjects("PTB").Name  ' "PTB"
    Debug.Print HideSheet.ListObjects("결산연월").Name  ' "결산연월"
    Debug.Print AddCoA.ListObjects("CoA_Input").Name  ' "CoA_Input"
End Sub
```

모든 테이블 이름 정상 출력 → ✅

### 14.3 데이터 검증

#### ✅ CoAMaster 데이터

- 178개 행 (+ 헤더)
- Account 컬럼 6자리 숫자
- BSPL 컬럼 BS/IS/지분 값

#### ✅ PTB 데이터

- BSPL 시트 PTB 테이블에 데이터 존재
- 법인코드, 계정코드, 차변, 대변 데이터 채워짐
- PwC_CoA, PwC_계정과목명 데이터 채워짐 (녹색 배경)

#### ✅ 환율 데이터

- 환율정보(평균), 환율정보(일자) 시트 존재
- 통화 컬럼에 USD, EUR, JPY 등 데이터
- 환율 컬럼에 숫자 데이터
- KRW 기준선 존재 (환율=1.00)

### 14.4 리본 메뉴 검증

#### ✅ 리본 탭 표시

- Excel 상단에 "연결마스터" 탭
- 7개 그룹 표시

#### ✅ 버튼 동작 확인

| 버튼 | 예상 동작 | 확인 방법 |
|------|-----------|-----------|
| 버전 정보 | 메시지 박스 표시 | 클릭 → 버전 1.00 표시 |
| SPO 설정 | frmSPO 폼 표시 | 클릭 → 폼 열림 |
| 평균환율 조회 | frmCalendar → 환율 데이터 조회 | 클릭 → 날짜 선택 → 시트 생성 |
| CoA 확인 및 데이터 합산 | PTB 새로고침 + 강조 | 클릭 → 노란색 행 표시 |

모든 버튼 정상 동작 → ✅

### 14.5 워크플로 검증

#### ✅ Check 시트 상태

- 12개 단계 중 완료된 단계 "Complete" 표시
- 녹색 배경 적용
- 작업일시, 작업자 정보 자동 기록

#### ✅ 검증 공식

BSPL 시트에서 차변=대변 검증:

```excel
=SUMIFS(PTB[차변-대변], PTB[BSPL], "BS", PTB[대분류], "자산") - SUMIFS(PTB[차변-대변], PTB[BSPL], "BS", PTB[대분류], "부채") - SUMIFS(PTB[차변-대변], PTB[BSPL], "지분", PTB[대분류], "자본")
```

**결과**: 0 → ✅ (녹색 배경)
**결과**: ≠0 → ❌ (빨간색 배경 + 차이금액 표시)

### 14.6 파일 저장 및 백업

1. **Ctrl + S** → 파일 저장
2. **파일 → 다른 이름으로 저장**
   - 파일명: `연결마스터_HRE_v1.00_백업_20260121.xlsm`
   - 위치: 별도 폴더
3. VBA 코드 내보내기:
   - VBA 편집기에서 Module1의 `ExportAllVbaComponents()` 실행
   - `/Users/jaewookim/Desktop/Project/HRE/작업/VBA_Export/` 폴더에 모든 .bas 파일 저장

**✅ 최종 성공 확인**:
- Excel 파일 정상 저장
- 백업 파일 생성
- VBA 코드 내보내기 완료
- 모든 체크리스트 ✅

---

## PART 5: 참고자료

## 15. 문제 해결 가이드

### 15.1 VBA 오류

#### 오류 1: "컴파일 오류: Sub 또는 Function이 정의되지 않았습니다"

**원인**: 참조되는 모듈이 임포트되지 않음

**해결**:
1. 오류 메시지의 함수 이름 확인 (예: `SpeedUp`)
2. 해당 함수가 포함된 모듈 확인 (`mod_10_Public.bas`)
3. 프로젝트 탐색기에서 모듈 존재 여부 확인
4. 없으면 재임포트

#### 오류 2: "실행 시간 오류 '9': 인덱스가 유효 범위를 벗어났습니다"

**원인**: 테이블 또는 시트 이름 오타

**해결**:
1. 오류 발생 줄의 코드 확인 (예: `BSPL.ListObjects("PTB")`)
2. 실제 테이블 이름 확인 (대소문자, 띄어쓰기 포함)
3. 이름 수정 또는 테이블 재생성

#### 오류 3: "형식이 일치하지 않습니다"

**원인**: 데이터 타입 불일치

**해결**:
1. 변수 선언 확인 (`Dim x As Long` vs `Dim x As String`)
2. 입력 데이터 형식 확인 (숫자 vs 텍스트)
3. 필요 시 `CStr()`, `CLng()` 등 변환 함수 사용

### 15.2 리본 메뉴 오류

#### 오류 1: "연결마스터" 탭이 안 보임

**원인 1**: XML 오류

**해결**:
1. Custom UI Editor에서 파일 열기
2. **Validate** 버튼 클릭 → 오류 메시지 확인
3. XML 태그 닫힘 확인
4. 저장 후 Excel 재시작

**원인 2**: Excel 보안 설정

**해결**:
1. **파일** → **옵션** → **보안 센터** → **보안 센터 설정**
2. **신뢰할 수 있는 위치**에 작업 폴더 추가
3. Excel 재시작

#### 오류 2: 버튼 클릭 시 "매크로를 찾을 수 없습니다"

**원인**: VBA 모듈 누락 또는 함수 이름 불일치

**해결**:
1. XML의 `onAction` 속성 확인 (예: `onAction="SetSPO"`)
2. mod_Ribbon.bas에서 해당 함수 존재 확인
3. 함수 이름 일치 여부 확인 (대소문자 구분 안 함)

### 15.3 SharePoint 연결 오류

#### 오류 1: "데이터를 가져올 수 없습니다"

**원인 1**: SharePoint URL 오류

**해결**:
1. Power Query M 코드의 `SharePointURL` 확인
2. 브라우저에서 URL 직접 접속하여 유효성 확인
3. 올바른 URL로 수정

**원인 2**: 인증 오류

**해결**:
1. **데이터** → **쿼리 편집** → **데이터 원본 설정**
2. SharePoint 원본 선택 → **권한 편집**
3. **조직 계정** 선택 → Office 365 계정으로 재인증

#### 오류 2: "파일을 찾을 수 없습니다"

**원인**: 파일명 규칙 불일치

**해결**:
1. SharePoint 폴더에서 파일명 확인
2. `시산표_{법인코드}_{YYYYMM}.xlsx` 형식 준수 여부
3. M 코드의 `CurrentYear`, `CurrentMonth` 변수 확인
4. 파일명 수정 또는 M 코드 수정

### 15.4 환율 조회 오류

#### 오류 1: "환율 정보를 가져올 수 없습니다"

**원인 1**: 인터넷 연결 끊김

**해결**:
1. 인터넷 연결 확인
2. KEB 하나은행 웹사이트 접속 테스트
3. 재시도

**원인 2**: KEB API 변경

**해결**:
1. mod_17_ExchangeRate.bas의 `GetHtmlFlow()` 함수 확인
2. HTTP 요청 URL 및 파라미터 확인
3. KEB 하나은행 환율 페이지 구조 변경 여부 확인
4. 필요 시 코드 수정

#### 오류 2: "날짜 선택 오류"

**원인**: 미래 날짜 또는 공휴일 선택

**해결**:
1. 오늘 날짜 또는 이전 날짜 선택
2. 1월 1일 선택 시 자동으로 1월 2일로 조정됨
3. 토/일/공휴일은 이전 영업일로 자동 조정

### 15.5 한글 깨짐 오류

#### 오류: VBA 코드에서 한글이 "����" 표시

**원인**: UTF-8 인코딩 손실

**해결 1**: 파일 재임포트
1. 손상된 모듈 제거
2. `/Users/jaewookim/Desktop/Project/HRE/작업/VBA_Export/` 폴더의 원본 파일 재임포트

**해결 2**: 코드 직접 수정
1. VBA 편집기에서 깨진 한글 부분 찾기
2. 직접 한글로 재입력
3. 저장

**예시**:
```vba
' 수정 전 (깨짐)
Msg "����� �����Դϴ�!"

' 수정 후
Msg "환율 조회가 완료되었습니다!"
```

---

## 16. 부록: 테이블 스키마 전체

### 16.1 CoAMaster - Master 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 | 설명 |
|--------|-------------|------|------|------|
| Account | TEXT | 필수 | 110110 | PwC 표준 계정코드 (6자리) |
| Description | TEXT | 필수 | Cash and cash equivalents | 영문 계정명 |
| 연결계정명 | TEXT | 필수 | 현금및현금성자산 | 한글 계정명 |
| 분류 | TEXT | 선택 | 유동자산 | 한글 분류 |
| Category | TEXT | 선택 | Current asset | 영문 분류 |
| BSPL | TEXT | 필수 | BS | 재무제표 구분 (BS/IS/지분) |
| 대분류 | TEXT | 필수 | 자산 | 자산/부채/자본/수익/비용 |
| Ranking | NUMBER | 필수 | 110 | 표시 순서 (100 단위) |
| 부호 | TEXT | 필수 | D | 차변(D)/대변(C) |
| 금액 | CURRENCY | 선택 | 0 | 집계 금액 (VBA 계산) |
| 비고 | TEXT | 선택 | | 메모 |

**행 개수**: 178개 (+ 헤더 1개)

**PRIMARY KEY**: Account

### 16.2 CorpMaster - Corp 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 | 설명 |
|--------|-------------|------|------|------|
| 법인코드 | TEXT | 필수 | HRE-001 | 법인 고유 코드 |
| 법인명 | TEXT | 필수 | 한국재생에너지 주식회사 | 한글 법인명 |
| Entity Name | TEXT | 선택 | Korea Renewable Energy Co., Ltd. | 영문 법인명 |
| Hierarchy | TEXT | 선택 | Level 1 | 그룹 계층 구조 |
| Scope | TEXT | 필수 | O | 연결범위 포함 여부 |
| 취득일 | DATE | 필수 | 2020-01-01 | 법인 취득일 |
| 처분일 | DATE | 선택 | 2025-12-31 | 법인 처분일 (현재 보유 시 빈칸) |
| 지분율 | PERCENTAGE | 필수 | 100% | 지분율 (0-1 범위) |
| 기능통화 | TEXT | 필수 | KRW | 기능통화 코드 |
| Consolidation Method | TEXT | 필수 | Full | 연결방법 (Full/Equity/Cost) |

**PRIMARY KEY**: 법인코드

### 16.3 CorpCoA - Raw_CoA 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 | 설명 |
|--------|-------------|------|------|------|
| 법인코드 | TEXT | 필수 | HRE-001 | 법인 코드 |
| 계정코드 | TEXT | 필수 | 10300, 11401_내부거래 | 법인별 계정코드 (5자리 + 접미사) |
| 연결계정명 | TEXT | 선택 | 당좌예금 | 한글 계정명 |
| Reporting COA | TEXT | 선택 | 110110 | 대안 계정코드 (폴백) |
| Account | TEXT | 필수 | 110110 | PwC 표준 계정코드 (6자리) |
| Description | TEXT | 선택 | Cash and cash equivalents | 영문 계정명 |
| Variant Type | TEXT | 필수 | BASE, INTERCO_KR, INTERCO_IC | 변종 타입 |
| Internal Transaction Flag | TEXT | 선택 | Y/N | 내부거래 플래그 |
| 비고 | TEXT | 선택 | | 메모 |

**COMPOSITE KEY**: (법인코드, 계정코드, Variant Type)

### 16.4 BSPL - PTB 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 | 설명 |
|--------|-------------|------|------|------|
| 법인코드 | TEXT | 필수 | HRE-001 | 법인 코드 |
| 계정코드 | TEXT | 필수 | 10300 | 법인별 계정코드 |
| 계정과목명 | TEXT | 필수 | 당좌예금 | 한글 계정명 |
| 차변 | CURRENCY | 필수 | 1000000 | 차변 금액 |
| 대변 | CURRENCY | 필수 | 0 | 대변 금액 |
| 차변-대변 | CURRENCY | 자동 | 1000000 | 순액 (Power Query 계산) |
| PwC_CoA | TEXT | VBA | 110110 | PwC 표준 계정코드 (VBA 매핑) |
| PwC_계정과목명 | TEXT | VBA | Cash and cash equivalents | 영문 계정명 (VBA 매핑) |

**데이터 소스**: Power Query (SharePoint)

### 16.5 HideSheet - 결산연월 테이블 ⭐ Power Query 참조

| 컬럼명 | 데이터 타입 | 필수 | 예시 |
|--------|-------------|------|------|
| 결산연도 | NUMBER | 필수 | 2026 |
| 결산월 | NUMBER | 필수 | 1 |

**행 개수**: 1개 (+ 헤더)
**Power Query 참조**: `결산연도`, `결산월` 컬럼명 정확히 일치 필요

### 16.6 HideSheet - Path 테이블 ⭐ Power Query 참조

| 컬럼명 | 데이터 타입 | 필수 | 예시 |
|--------|-------------|------|------|
| 메인주소 | TEXT | 필수 | https://pwckor.sharepoint.com/sites/KR-ASR-HRE_Consolidation |

**행 개수**: 1개 (+ 헤더)
**Power Query 참조**: `메인주소` 쿼리가 이 테이블 참조

### 16.7 HideSheet - TempPath 테이블 ⭐ Power Query 참조

| 컬럼명 | 데이터 타입 | 필수 | 예시 |
|--------|-------------|------|------|
| 이름 | TEXT | 선택 | (빈칸) |
| 구분 | TEXT | 선택 | (빈칸) |
| Description | TEXT | 선택 | (빈칸) |
| 경로 | TEXT | 필수 | /★시연용폴더★/HRE/2512 |

**행 개수**: 1개 (+ 헤더)
**Power Query 참조**: `회사결산 주소` 쿼리가 `경로` 컬럼 참조
**⚠️ 중요**: 컬럼명이 `경로`가 아니면 Power Query 오류 발생

### 16.8 HideSheet - Mode 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 |
|--------|-------------|------|------|
| Mode | TEXT | 필수 | D |

**행 개수**: 1개 (+ 헤더)
**값**: D=Debit(차변 기준), C=Credit(대변 기준)

### 16.9 HideSheet - Link 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 |
|--------|-------------|------|------|
| SPO_Link | TEXT | 필수 | https://pwckor.sharepoint.com/sites/... |
| Path | TEXT | 선택 | (빈칸) |

**행 개수**: 1개 (+ 헤더)

### 16.10 AddCoA - CoA_Input 테이블

| 컬럼명 | 데이터 타입 | 필수 | 예시 | 설명 |
|--------|-------------|------|------|------|
| 법인코드 | TEXT | VBA | HRE-001 | VBA가 자동 입력 |
| 법인별CoA | TEXT | VBA | 10300 | VBA가 자동 입력 |
| 법인별계정과목명 | TEXT | VBA | 당좌예금 | VBA가 자동 입력 |
| PwC_CoA | TEXT | 제안/수동 | 110110 | First Drafting 제안 또는 수동 |
| PwC_계정과목명 | TEXT | 제안/수동 | Cash and cash equivalents | First Drafting 제안 또는 수동 |
| 적요 | TEXT | 선택 | | 메모 |
| 비고 | TEXT | 선택 | | 메모 |

**데이터 소스**: VBA `Fill_Input_Table()`

---

**문서 버전**: 1.1
**최종 수정**: 2026-01-23
**변경 내역**:
- v1.1 (2026-01-23): Power Query 섹션 전면 개편, HideSheet 테이블 구조 보완
- v1.0 (2026-01-21): 초기 버전
**작성자**: HRE 프로젝트 팀
**© 2026 Samil PwC. All rights reserved.**
